<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
   xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
   <head>
      <meta charset="UTF-8">
      <title>FuturePath | Assessment</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
      <link rel="stylesheet" th:href="@{/css/common.css}" />
      <link rel="stylesheet" th:href="@{/css/assessment.css}" />
   </head>
   <body>
      <nav th:replace="~{sidebar :: sidebar}"></nav>
      <main>
         <nav th:replace="~{header :: header}"></nav>
         <hr>
         <nav class="sub-header">
            ASSESSMENT
            <div class="btn-group">
            </div>
         </nav>
         <hr>
         <div class="content">
            <div class="assessment-container" th:if="${questionDto.questions != null and !#lists.isEmpty(questionDto.questions)}">
               <!-- Question Navigation -->
               <div class="question-nav">
                  <h3>Questions</h3>
                  <div class="question-list" id="questionList">
                     <button th:each="question, iterStat : ${questionDto.questions}"
                        type="button"
                        th:text="${iterStat.index + 1}"
                        th:attr="data-question=${iterStat.index + 1}">
                     </button>
                  </div>
               </div>
               <!-- Assessment Form -->
               <form th:action="@{/assessment/result}" method="POST" th:object="${assessmentDto}" class="assessment-form">
                  <input type="hidden" name="mode" th:value="${mode}" />                
                  <input type="hidden" name="answeredJson" id="answeredJson" />
                  <div class="question-card" th:each="question, iterStat : ${questionDto.questions}">
                     <div class="message">
                        <strong th:text="${iterStat.index + 1} + '. ' + ${question.question}">1. Sample question text</strong><br>
                        <span>Select the most appropriate answer.</span>
                     </div>
                     <div class="choices">
                        <button type="button" name="q1" th:each="answer : ${question.answers}" 
                           th:text="${answer.answer}" th:data-answer-id="${answer.answerIdPk}">
                        Choice
                        </button>
                     </div>
                  </div>
                  <button type="submit" class="submit-btn" id="submitAssessmentBtn">
                  <i class="fa-solid fa-paper-plane"></i> Submit Assessment
                  </button>
               </form>
               <button id="backToTopBtn" title="Back to Top">
               <i class="fa-solid fa-chevron-up"></i>
               </button>
            </div>
            <div th:if="${questionDto.questions == null or #lists.isEmpty(questionDto.questions)}" class="no-questions" 
               style="margin: auto; text-align: center;">
               <p>No Questions Right Now.</p>
               <a th:href="@{/dashboard}" class="btn-back-dashboard">Back to Dashboard</a>
            </div>
         </div>
      </main>
      <script th:inline="javascript">
         document.addEventListener("DOMContentLoaded", () => {
            const webDto = /*[[${questionDto}]]*/ {};
            const questionCards = document.querySelectorAll(".question-card");
            const questionNavBtns = document.querySelectorAll(".question-list button");
            const backToTopBtn = document.getElementById("backToTopBtn");
            const answeredInput = document.getElementById("answeredJson"); // ðŸ”¥ hidden input reference
         
            const questionAnswers = {};
         
            questionCards.forEach((card, index) => {
                const choices = card.querySelectorAll(".choices button");
                const questionIdPk = webDto.questions[index]?.idPk;
         
                questionAnswers[questionIdPk] = null;
         
                choices.forEach(choice => {
                    choice.addEventListener("click", () => {
                        choices.forEach(btn => btn.classList.remove("selected"));
                        choice.classList.add("selected");
         
                        const answerIdPk = choice.getAttribute("data-answer-id");
                        questionAnswers[questionIdPk] = parseInt(answerIdPk);
         
                        questionNavBtns[index].classList.add("answered");
         
                        // ðŸ”¥ Update the hidden input field every time the user picks an answer
                        answeredInput.value = JSON.stringify(questionAnswers);
         
                        console.log("Selected:", { questionIdPk, answerIdPk });
                        console.log("Question Answers:", questionAnswers);
                    });
                });
            });
         
            // Scroll button logic (unchanged)
            window.addEventListener("scroll", () => {
                backToTopBtn.style.display = window.scrollY > 300 ? "block" : "none";
            });
         
            questionNavBtns.forEach((btn, index) => {
                btn.addEventListener("click", () => {
                    const questionCard = questionCards[index];
                    if (questionCard) {
                        questionCard.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                });
            });
         
            backToTopBtn.addEventListener("click", () => {
                window.scrollTo({ top: 0, behavior: "smooth" });
            });
         });
         
      </script>
   </body>
</html>