<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
   xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
   <head>
      <meta charset="UTF-8">
      <title>FuturePath | Assessment Result</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>    
      <link rel="stylesheet" th:href="@{/css/common.css}" />
      <link rel="stylesheet" th:href="@{/css/assessment-result.css}" />
   </head>
   <body>
      <nav th:replace="~{sidebar :: sidebar}"></nav>
      <main th:object="${assessmentDto}">
         <nav th:replace="~{header :: header}"></nav>
         <hr>
         <nav class="sub-header">
         	<div>
          	  <span class="crumb">FuturePath</span>
			  <i class="fa-solid fa-chevron-right separator"></i>
    	      <span class="crumb">ASSESSMENT</span>
    	      <i class="fa-solid fa-chevron-right separator"></i>
    	      <span class="crumb active">RESULT</span>
          	</div>
         </nav>
         <hr>
         <div class="content">
            <!-- Result Summary -->
            <div class="result-summary">
               <h2>Assessment Completed üéâ</h2>
               <div class="result-stats">
                  <div class="stat-box"><strong>‚úÖ Correct: </strong><span th:text=" *{totalCorrect}">0</span></div>
                  <div class="stat-box"><strong>‚ùå Incorrect: </strong><span th:text=" *{totalIncorrect}">0</span></div>
                  <div class="stat-box"><strong>üìä Score: </strong><span th:text="|*{percentage}%|">0%</span></div>
               </div>
               <section class="top-recommendations">
                  <h3>üèÜ Top 3 Recommended Fields</h3>
                  <div class="top-list" th:if="*{top3Recommendations != null and !top3Recommendations.isEmpty()}">
                     <div class="top-item" th:each="rec, stat : *{top3Recommendations}">
                        <span class="rank" th:text="${stat.count} + '.'"></span>
                        <span class="rec-name" th:text="${rec.name}"></span>
                        <span class="rec-percent" th:text="|(${#numbers.formatDecimal(rec.percentage, 1, 1)}%)|"></span>
                     </div>
                  </div>
                  <p th:unless="*{top3Recommendations != null and !top3Recommendations.isEmpty()}" style="text-align:center; color:#aab6ff; margin-top:1rem;">
                     I'm sorry, you currently have no recommendations based on your answers.
                  </p>
               </section>
               <section class="university-programs">
                  <h3>üéì All Universities Offering Programs</h3>
                  <div class="university-list" id="universityList">
                     <div class="university-item"
                        th:each="university, iterStat : *{universities}"
                        th:classappend="${iterStat.index >= 3} ? 'hidden' : ''">
                        <div class="uni-header">
                           <span class="uni-name" th:text="${university.universityName}"></span>
                           <button class="view-btn"
                              type="button"
                              th:onclick="'window.location.href=\'/universities/' + ${university.universityIdPk} + '\''">
                           View
                           </button>
                        </div>
                        <ul class="degree-list">
                           <li th:each="program : ${university.offeredPrograms}" th:text="${program}"></li>
                        </ul>
                     </div>
                  </div>
                  <button id="showMoreBtn"
                     th:if="*{universities != null and universities.size() > 3}"
                     type="button"
                     class="show-more-btn">
                  Show More
                  </button>
                  <p th:unless="*{universities != null and !universities.isEmpty()}"
                     class="no-universities">
                     No universities available at the moment.
                  </p>
               </section>
               <section class="scores-breakdown">
                  <h3>üéØ Scores Breakdown</h3>
                  <div class="recommendation-list">
                     <div th:each="rec, iterStat : *{recommendationMap.values()}" class="score-row">
                        <div class="score-icon">
                           <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="score-name" th:text="${rec.code}"></div>
                        <div class="score-bar">
                           <div class="score-bar-fill" 
                              th:style="'width:' + ${rec.percentage} + '%;'" 
                              th:text="${#numbers.formatDecimal(rec.percentage, 1, 1)} + '%'"></div>
                        </div>
                     </div>
                  </div>
               </section>
            </div>
            <div class="next-steps">
               <h3>Next Steps</h3>
               <button onclick="window.location.href='/assessment'">Retake Assessment</button>
               <button id="downloadSummaryBtn" type="button">Download Result (PDF)</button>
               <button onclick="window.location.href='/dashboard'">Go to Dashboard</button>
            </div>
            <div class="question-results">
               <h3>Question Breakdown</h3>
               <div class="question-card" th:each="question, iterStat : *{questions}">
                  <h4 th:text="${iterStat.index + 1} + '. ' + ${question.question}"></h4>
                  <div class="answer"
                     th:classappend="${question.isCorrect} ? ' correct' : ' incorrect'">
                     Your Answer: <span th:text="${question.userAnswer}"></span>
                  </div>
                  <div class="correct-answer"
                     th:if="${!question.isCorrect}">
                     ‚úî Correct Answer: <span th:text="${question.correctAnswer}"></span>
                  </div>
               </div>
            </div>
         </div>
         <script th:inline="javascript">
	         console.clear();
	         console.log( /*[[${assessmentDto}]]*/ '');
	         document.addEventListener("DOMContentLoaded", function() {
	             const showMoreBtn = document.getElementById("showMoreBtn");
	             if (!showMoreBtn) return;
	
	             showMoreBtn.addEventListener("click", () => {
	                 document.querySelectorAll("#universityList .hidden").forEach(el => el.classList.remove("hidden"));
	                 showMoreBtn.style.display = "none";
	             });
	         });
	
	         document.getElementById("downloadSummaryBtn")?.addEventListener("click", async function() {
	             const {
	                 jsPDF
	             } = window.jspdf;
	             const summaryElement = document.querySelector(".result-summary");
	
	             if (!summaryElement) {
	                 alert("Summary section not found!");
	                 return;
	             }
	
	             summaryElement.scrollIntoView();
	
	             const canvas = await html2canvas(summaryElement, {
	                 scale: 2,
	                 useCORS: true,
	             });
	
	             const imgData = canvas.toDataURL("image/png");
	             const pdf = new jsPDF({
	                 orientation: "portrait",
	                 unit: "px",
	                 format: "a4"
	             });
	
	             const pdfWidth = pdf.internal.pageSize.getWidth();
	             const pdfHeight = pdf.internal.pageSize.getHeight();
	
	             const imgWidth = pdfWidth - 40;
	             const imgHeight = (canvas.height * imgWidth) / canvas.width;
	
	             const yOffset = 20;
	             pdf.addImage(imgData, "PNG", 20, yOffset, imgWidth, imgHeight);
	
	             pdf.save("Assessment_Summary.pdf");
	         });
         </script>
      </main>
   </body>
</html>